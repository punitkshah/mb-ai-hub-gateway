<fragment>
	<set-variable name="routes" value="@{
    JArray routes = (JArray)context.Variables["routes"];
    string activeBackendId = (string)context.Variables["backendId"];

    // MUST match azure-openai-token-limit tokens-per-minute
    int tpmMax = 20000;

    int remaining = context.Variables.ContainsKey("BackendRemainingTokens")
      ? Convert.ToInt32(context.Variables["BackendRemainingTokens"])
      : -1;

    DateTime now = DateTime.UtcNow;

    for (int i = 0; i < routes.Count; i++)
    {
      JObject route = (JObject)routes[i];

      // still keep per-route limit as a "switch threshold", but interpret it as tokens-per-minute threshold
      int switchThresholdTokens = route.Value<int?>("targetTPMLimit") ?? -1;
      if (switchThresholdTokens <= 0)
      {
        continue;
      }

      if (route["isThrottling"] == null) { route["isThrottling"] = false; }
      if (route["retryAfter"] == null) { route["retryAfter"] = DateTime.MinValue; }

      // Expire throttling window
      if (route.Value<bool>("isThrottling") && now >= route.Value<DateTime>("retryAfter"))
      {
        route["isThrottling"] = false;
        route["retryAfter"] = DateTime.MinValue;
      }

      string backendId = route.Value<string>("backend-id");

      // Only update the backend that actually handled this request
      if (backendId == activeBackendId && remaining >= 0)
      {
        int consumed = tpmMax - remaining;

        if (consumed < 0) { consumed = 0; }
        if (consumed > tpmMax) { consumed = tpmMax; }

        // For visibility
        route["consumedTokens"] = consumed;
        route["consumedPercentage"] = (double)consumed / (double)tpmMax;

        // Switch when consumed tokens exceed your route threshold (e.g., 1000)
        if (consumed >= switchThresholdTokens)
        {
          if (route.Value<bool>("isThrottling") == false)
          {
            route["isThrottling"] = true;
            route["retryAfter"] = now.AddSeconds(30);
          }
        }
      }
    }

    return routes;
  }" />
	<cache-store-value key="@((string)context.Variables["routesCacheKey"])" value="@((JArray)context.Variables["routes"])" duration="60" />
</fragment>