<fragment>
	<!-- Expire any old throttling windows -->
	<set-variable name="routes" value="@{
    JArray routes = (JArray)context.Variables["routes"];
    DateTime now = DateTime.UtcNow;

    for (int i = 0; i < routes.Count; i++)
    {
      JObject route = (JObject)routes[i];
      if (route.Value<bool>("isThrottling") && now >= route.Value<DateTime>("retryAfter"))
      {
        route["isThrottling"] = false;
        route["retryAfter"] = DateTime.MinValue;
      }
    }

    return routes;
  }" />
	<!-- Persist any expirations back to cache -->
	<cache-store-value key="@((string)context.Variables["routesCacheKey"])" value="@((JArray)context.Variables["routes"])" duration="60" />
	<!-- Pick a route -->
	<set-variable name="routeIndex" value="@{
    JArray routes = (JArray)context.Variables["routes"];
    string allowedBackend = (string)context.Variables.GetValueOrDefault("allowedBackend", "");
    string[] allowedBackends = string.IsNullOrEmpty(allowedBackend) ? new string[0] : allowedBackend.Split(',');

    int selectedPriority = Int32.MaxValue;
    List<int> available = new List<int>();

    for (int i = 0; i < routes.Count; i++)
    {
      JObject route = (JObject)routes[i];
      string backendId = route.Value<string>("backend-id");

      bool isBackendAllowed = string.IsNullOrEmpty(allowedBackend) || allowedBackends.Contains(backendId.Trim());

      if (!route.Value<bool>("isThrottling") && isBackendAllowed)
      {
        int pr = route.Value<int>("priority");

        if (pr < selectedPriority)
        {
          selectedPriority = pr;
          available.Clear();
          available.Add(i);
        }
        else if (pr == selectedPriority)
        {
          available.Add(i);
        }
      }
    }

    if (available.Count == 1)
    {
      return available[0];
    }

    if (available.Count > 0)
    {
      return available[new Random().Next(0, available.Count)];
    }

    return -1;
  }" />
	<choose>
		<when condition="@((int)context.Variables["routeIndex"] == -1)">
			<return-response>
				<set-status code="503" reason="Service Unavailable" />
				<set-body>No backends are currently available</set-body>
			</return-response>
		</when>
	</choose>
	<set-variable name="backendId" value="@(((JObject)((JArray)context.Variables["routes"])[(int)context.Variables["routeIndex"]]).Value<string>("backend-id"))" />
	<set-variable name="routeLocation" value="@(((JObject)((JArray)context.Variables["routes"])[(int)context.Variables["routeIndex"]]).Value<string>("location"))" />
	<set-variable name="routeName" value="@(((JObject)((JArray)context.Variables["routes"])[(int)context.Variables["routeIndex"]]).Value<string>("name"))" />
</fragment>